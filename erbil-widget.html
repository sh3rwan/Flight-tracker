<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erbil Airport Flight Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary-color: #0d9488; --background-start: #f0fdfa; --background-end: #ccfbf1; }
        html { font-family: 'Inter', sans-serif; }
        .flight-widget { max-width: 900px; margin: 0 auto; border-radius: 1.5rem; background-image: linear-gradient(180deg, var(--background-start) 0%, var(--background-end) 100%); border: 1px solid var(--primary-color); }
        .status-scheduled { background-color: #f0fdfa; color: #0f766e; }
        .status-boarding { background-color: #fef9c3; color: #ca8a04; }
        .status-landed { background-color: #d1fae5; color: #065f46; }
        .status-delayed { background-color: #fee2e2; color: #b91c1c; }
        .status-cancelled { background-color: #fce7f3; color: #9d174d; }
        @media (max-width: 768px) {
            .responsive-table tr { display: block; margin-bottom: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; }
            .responsive-table th, .responsive-table td { padding: 0.25rem 0.5rem; display: block; text-align: right !important; }
            .responsive-table td:before { content: attr(data-label); float: left; font-weight: 600; text-transform: uppercase; margin-right: 1rem; color: #4b5563; }
            .responsive-table thead { display: none; }
        }
    </style>
</head>
<body class="p-4 bg-gray-50 min-h-screen">

    <div id="flight-widget" class="flight-widget p-4 sm:p-6 shadow-2xl">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2 sm:mb-0">Erbil Flight Status</h1>
            <button id="refresh-button" class="bg-teal-600 hover:bg-teal-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 disabled:opacity-50 flex items-center">
                <span id="btn-text">Refresh</span>
            </button>
        </div>

        <div class="flex border-b border-gray-300 mb-4 space-x-2 sm:space-x-4">
            <button data-type="all" class="tab-button py-2 px-3 sm:px-4 text-sm font-medium transition duration-150 border-b-2 border-transparent text-teal-600 border-teal-600 active-tab">All Flights</button>
            <button data-type="arrivals" class="tab-button py-2 px-3 sm:px-4 text-sm font-medium transition duration-150 border-b-2 border-transparent text-gray-600 hover:text-teal-600">Arrivals</button>
            <button data-type="departures" class="tab-button py-2 px-3 sm:px-4 text-sm font-medium transition duration-150 border-b-2 border-transparent text-gray-600 hover:text-teal-600">Departures</button>
        </div>

        <div id="flight-list-container">
            <div id="loading-indicator" class="text-center py-10 text-teal-600">Loading...</div>
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative"></div>
            <div id="last-updated" class="text-xs text-gray-500 mt-4 text-right hidden"></div>
        </div>
    </div>

    <script>
        // ---------------- CONFIGURATION ----------------
        // This is the Vercel API endpoint
        const API_BASE_URL = 'https://erbil-api.vercel.app/api/flights'; 
        // -----------------------------------------------

        const container = document.getElementById('flight-list-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorContainer = document.getElementById('error-message');
        const refreshButton = document.getElementById('refresh-button');
        const updatedElement = document.getElementById('last-updated');
        const tabButtons = document.querySelectorAll('.tab-button');
        let currentType = 'all'; 

        const getStatusClass = (s) => {
            s = s.toLowerCase();
            if (s.includes('landed') || s.includes('arrived')) return 'status-landed';
            if (s.includes('boarding')) return 'status-boarding';
            if (s.includes('delayed')) return 'status-delayed';
            if (s.includes('cancelled')) return 'status-cancelled';
            return 'status-scheduled';
        };

        async function fetchData() {
            loadingIndicator.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            refreshButton.disabled = true;
            refreshButton.textContent = 'Loading...';
            
            try {
                const endpoint = currentType === 'all' ? '' : `/${currentType}`;
                const res = await fetch(`${API_BASE_URL}${endpoint}`);
                
                if (!res.ok) {
                    throw new Error(`Server responded with status ${res.status}.`);
                }
                
                const data = await res.json();
                renderTable(data.flights || [], data.lastFetched ? new Date(data.lastFetched) : null);
            } catch (error) {
                console.error("Fetch Error:", error);
                errorContainer.textContent = `Error! Could not load flight data. The server might be down or misconfigured. (${error.message})`;
                errorContainer.classList.remove('hidden');
                
                // Hide table if error occurs
                const oldTable = container.querySelector('table');
                if(oldTable) oldTable.remove();
            } finally {
                loadingIndicator.classList.add('hidden');
                refreshButton.disabled = false;
                refreshButton.textContent = 'Refresh';
            }
        }

        async function refreshData() {
            refreshButton.disabled = true;
            refreshButton.textContent = 'Refreshing...';
            errorContainer.classList.add('hidden');

            try {
                // Determine refresh URL (e.g., https://erbil-api.vercel.app/api/flights/refresh)
                const refreshUrl = API_BASE_URL.replace('/flights', '/flights/refresh'); 
                
                const response = await fetch(refreshUrl, { method: 'POST' });
                
                if (!response.ok) {
                     // Check if it's a cold start/sleep issue
                    throw new Error(`Refresh failed with status ${response.status}. Try refreshing the page in a few seconds.`);
                }
                
                // Refresh successful, now fetch the new data
                await fetchData();
            } catch (e) { 
                console.error("Force Refresh Error:", e);
                errorContainer.textContent = `Error! Failed to force refresh. Backend server might be unreachable. (${e.message})`;
                errorContainer.classList.remove('hidden');
            } finally {
                refreshButton.disabled = false;
                refreshButton.textContent = 'Refresh';
            }
        }

        function renderTable(flights, lastFetchedTime) {
            // Remove old content
            container.querySelectorAll('table, .no-data').forEach(el => el.remove());
            updatedElement.classList.remove('hidden');

            if (lastFetchedTime) updatedElement.textContent = `Updated: ${lastFetchedTime.toLocaleTimeString()}`;

            if (flights.length === 0) {
                const div = document.createElement('div');
                div.className = 'no-data text-center py-10 text-gray-500';
                div.textContent = 'No flights found.';
                container.insertBefore(div, updatedElement);
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-300 bg-white rounded-xl shadow-lg';
            table.innerHTML = `
                <thead class="bg-teal-600 rounded-t-xl">
                    <tr>
                        <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white rounded-tl-xl">Time</th>
                        <th class="px-3 py-3.5 text-left text-sm font-semibold text-white">Flight</th>
                        <th class="px-3 py-3.5 text-left text-sm font-semibold text-white">City</th>
                        <th class="px-3 py-3.5 text-left text-sm font-semibold text-white hidden sm:table-cell">Airline</th>
                        <th class="py-3.5 pl-3 pr-4 text-center text-sm font-semibold text-white rounded-tr-xl">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 responsive-table">
                    ${flights.map(f => `
                        <tr class="hover:bg-gray-50 transition">
                            <td data-label="Time" class="whitespace-nowrap py-3 pl-4 pr-3 text-sm font-semibold text-gray-900">${new Date(f.scheduled).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                            <td data-label="Flight" class="whitespace-nowrap px-3 py-3 text-sm text-gray-700 font-bold">${f.flightNo}</td>
                            <td data-label="City" class="whitespace-nowrap px-3 py-3 text-sm text-gray-700">${f.city}</td>
                            <td data-label="Airline" class="whitespace-nowrap px-3 py-3 text-sm text-gray-500 hidden sm:table-cell">${f.airline}</td>
                            <td data-label="Status" class="whitespace-nowrap py-3 pl-3 pr-4 text-sm text-center"><span class="px-2 py-1 rounded-full text-xs font-semibold ${getStatusClass(f.status)}">${f.status}</span></td>
                        </tr>`).join('')}
                </tbody>`;
            container.insertBefore(table, updatedElement);
        }

        // --- Event Listeners ---
        tabButtons.forEach(btn => btn.addEventListener('click', (e) => {
            if (e.target.dataset.type === currentType) return;
            tabButtons.forEach(b => { 
                b.classList.remove('active-tab', 'border-teal-600', 'text-teal-600'); 
                b.classList.add('border-transparent', 'text-gray-600'); 
            });
            e.target.classList.add('active-tab', 'border-teal-600', 'text-teal-600');
            currentType = e.target.dataset.type;
            fetchData();
        }));

        refreshButton.addEventListener('click', refreshData);
        window.addEventListener('load', fetchData);
    </script>
</body>
</html>
